<!DOCTYPE html>
<html>
<head>
  <title>TURN-Only WebRTC Test</title>
</head>
<body>
  <h2>TURN-only Peer Test</h2>
  <button id="start">Start Connection</button>
  <pre id="log"></pre>

  <script>
    const log = msg => {
      console.log(msg);
      document.getElementById('log').textContent += msg + '\n';
    };

    const signaling = {
      send: msg => localStorage.setItem('webrtc-msg', JSON.stringify(msg)),
      onmessage: null
    };

    function checkInitialMessage() {
      const stored = localStorage.getItem('webrtc-msg');
      if (stored && signaling.onmessage) {
        signaling.onmessage(JSON.parse(stored));
      }
    }

    window.addEventListener('storage', event => {
      if (event.key === 'webrtc-msg' && signaling.onmessage) {
        signaling.onmessage(JSON.parse(event.newValue));
      }
    });


    async function getIceServers() {
      const res = await fetch('https://test-turn-server-6e6x.onrender.com/ice');
      const data = await res.json();
      return data.iceServers;
    }

    document.getElementById('start').onclick = async () => {
      const config = {
        iceServers: await getIceServers(),
        iceTransportPolicy: 'relay'
      };

      const pc = new RTCPeerConnection(config);
      pc.onicecandidate = e => {
        if (e.candidate) {
          signaling.send({ candidate: e.candidate });
        }
      };
      pc.onconnectionstatechange = () => {
        log(`Connection state: ${pc.connectionState}`);
      };

      signaling.onmessage = async msg => {
        if (msg.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        } else if (msg.offer) {
          await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          signaling.send({ answer });
        } else if (msg.candidate) {
          await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
      };

      // ðŸ‘‡ Check for any offer that might already exist
      checkInitialMessage();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      signaling.send({ offer });

      log('Offer sent. Open this page in another tab to complete the connection.');
    };
  </script>
</body>
</html>